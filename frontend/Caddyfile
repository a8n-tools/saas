################################################################################
# Main Caddy config
# https://caddyserver.com/docs/caddyfile/directives
################################################################################
{
	auto_https off
	admin off
}

(logging) {
	log {
		output stderr
		format json
		level INFO
	}
}

:{$PORT:8080} {
	root * /usr/share/caddy

	import logging

	# Health check endpoint
	handle /health {
		respond "healthy" 200
	}

	# Deny access to hidden files
	@hidden path /.*
	handle @hidden {
		respond 403
	}

	# Long-lived cache headers for hashed assets
	@assets path /assets/*
	header @assets Cache-Control "public, max-age=31536000, immutable"

	# Security headers
	header X-Frame-Options "SAMEORIGIN"
	header X-Content-Type-Options "nosniff"

	# Runtime config endpoint â€” injects env vars via Caddy templates
	handle /config.js {
		header Content-Type "application/javascript"
		templates
		respond `window.__RUNTIME_CONFIG__ = { apiUrl: "{{env "VITE_API_URL"}}", appDomain: "{{env "VITE_APP_DOMAIN"}}", showBusinessPricing: "{{env "VITE_SHOW_BUSINESS_PRICING"}}" };` 200
	}

	# SPA fallback - serve index.html for all routes
	try_files {path} /index.html
	file_server
}
